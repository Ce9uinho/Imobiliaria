<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Avalie o seu imóvel</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .thumbs{display:flex;flex-wrap:wrap;gap:.5rem;margin:.5rem 0}
    .thumbs img{width:92px;height:92px;object-fit:cover;border-radius:8px;border:1px solid #ddd}
    .block{display:block;margin:.75rem 0 .25rem}
    .status{margin:.5rem 0;color:#0c4a6e}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:1rem;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .muted{color:#6b7280}
    #debug{white-space:pre-wrap;background:#0b1020;color:#cde3ff;padding:.75rem;border-radius:10px;font-family:ui-monospace,monospace;font-size:.9rem}
  </style>
</head>
<body>
<header>
  <h1>Imobiliária</h1>
  <nav>
    <a href="index.html">Home</a>
    <a href="imoveis.html">Imóveis</a>
    <a href="vender.html" class="active">Avaliar imóvel</a>
    <a href="blog.html">Blog</a>
  </nav>
</header>

<main class="container">
  <section class="hero">
    <h2>Avalie o seu imóvel em segundos</h2>
    <p>Estimativa automática baseada nos teus comparáveis. IA de fotos quando disponível.</p>
  </section>

  <section class="evaluation-form">
    <h3>Detalhes do imóvel</h3>
    <form id="valuationForm">
      <input type="text" id="address" placeholder="Morada (ex.: Lisboa, Porto…)" required/>
      <select id="typology" required>
        <option value="">Tipologia</option>
        <option>T0</option><option>T1</option><option>T2</option>
        <option>T3</option><option>T4</option><option>Moradia</option>
      </select>
      <input type="number" id="areaUseful" placeholder="Área útil (m²)" required/>
      <input type="number" id="yearBuilt" placeholder="Ano de construção"/>
      <div class="features-checkboxes">
        <label><input type="checkbox" value="garagem"/> Garagem</label>
        <label><input type="checkbox" value="elevador"/> Elevador</label>
        <label><input type="checkbox" value="varanda"/> Varanda</label>
        <label><input type="checkbox" value="jardim"/> Jardim</label>
        <label><input type="checkbox" value="suite"/> Suite</label>
      </div>

      <label class="block">Fotos do imóvel (até 6):</label>
      <input type="file" id="photos" accept="image/*" multiple/>
      <div id="photoPreview" class="thumbs"></div>

      <h3>Contacto</h3>
      <input type="text" id="ownerName" placeholder="O seu nome" required/>
      <input type="email" id="ownerEmail" placeholder="Email" required/>
      <input type="tel" id="ownerPhone" placeholder="Telefone"/>
      <label class="gdpr"><input type="checkbox" id="ownerConsent" required/> Concordo com o tratamento dos meus dados.</label>

      <button type="submit">Obter avaliação</button>
      <p id="valuationStatus" class="status"></p>
    </form>
  </section>

  <section id="valuationResult" class="card" style="display:none">
    <h4>Estimativa</h4>
    <p><strong id="estMain"></strong></p>
    <p>Intervalo provável: <span id="estRange"></span></p>
    <p class="muted">
      Baseado em <span id="estComps"></span> comparáveis, ajustes e (se disponível) análise de fotos no teu dispositivo.
    </p>
    <div id="aiReport" class="card" style="margin-top:.75rem; display:none">
      <h4>Relatório da análise</h4>
      <p id="aiReportTxt" class="muted"></p>
    </div>
  </section>

  <section>
    <h3>Debug</h3>
    <div id="debug">–</div>
  </section>
</main>

<footer><p>&copy; 2025 Imobiliária</p></footer>

<!-- ===== Script com fallback garantido ===== -->
<script>
window.addEventListener('DOMContentLoaded', () => {
  const $ = s => document.querySelector(s);
  const log = (m) => { const el = $('#debug'); el.textContent += (el.textContent==='–'?'': '\\n') + m; };
  const setStatus = (t) => { const el = $('#valuationStatus'); if (el) el.textContent = t||''; };
  const fmtEUR = n => Number(n).toLocaleString('pt-PT',{style:'currency',currency:'EUR'});
  const INFLATION_DISCOUNT = 0.10;

  // Preview de fotos
  $('#photos')?.addEventListener('change', (e)=>{
    const preview = $('#photoPreview'); if (!preview) return;
    preview.innerHTML = '';
    Array.from(e.target.files||[]).slice(0,6).forEach(f=>{
      const img = document.createElement('img'); img.alt=f.name; img.title=f.name;
      const fr = new FileReader(); fr.onload = ()=> img.src = fr.result; fr.readAsDataURL(f);
      preview.appendChild(img);
    });
  });

  function getCheckedFeatures(){
    return Array.from(document.querySelectorAll('.features-checkboxes input:checked')).map(i=>i.value);
  }

  async function estimateLocal(input, imageAdj = {deduct:0, reasons:[]}) {
    log('A carregar dados: docs/data/properties.json');
    const res = await fetch('data/properties.json?bust=' + Date.now());
    if (!res.ok) throw new Error('Falha a ler dados ('+res.status+')');
    const props = await res.json();
    log('Total de imóveis carregados: ' + props.length);

    const area = Number(input.areaUseful||0);
    if (!area) throw new Error('Área inválida');

    let comps = props.filter(p =>
      p && Number(p.area)>0 && Number(p.price)>0 &&
      (!input.typology || p.typology === input.typology) &&
      p.area >= area*0.7 && p.area <= area*1.3
    );
    log('Comps após tipologia+área: ' + comps.length);

    const key = (input.address||'').toLowerCase();
    if (key){
      const hit = s => (s||'').toLowerCase().includes(key);
      const loc = comps.filter(p => hit(p.title)||hit(p.description)||hit(p.location?.city));
      if (loc.length >= 4) { comps = loc; log('Heurística de localização aplicada.'); }
    }
    if (comps.length < 5) { comps = props.filter(p=>!input.typology || p.typology===input.typology); log('Alargado por tipologia: '+comps.length); }
    if (comps.length < 5) { comps = props.filter(p=>Number(p.area)>0 && Number(p.price)>0); log('Fallback a todos: '+comps.length); }

    const ppms = comps.map(p => p.price / p.area).sort((a,b)=>a-b);
    const pick = q => ppms[Math.max(0, Math.min(ppms.length-1, Math.floor(ppms.length*q)))];
    const q1=pick(0.25), med=pick(0.50), q3=pick(0.75);

    let adj = 1 - INFLATION_DISCOUNT;
    if (Number(input.yearBuilt) >= 2010) adj += 0.05;
    const f = new Set((input.features||[]).map(s=>s.toLowerCase()));
    if (f.has('elevador')) adj += 0.03;
    if (f.has('garagem'))  adj += 0.04;
    if (f.has('varanda'))  adj += 0.02;
    if (f.has('jardim'))   adj += 0.03;
    if (f.has('suite'))    adj += 0.02;

    const imgDeduct = Math.min(0.25, imageAdj.deduct||0);
    adj = Math.max(0.5, adj - imgDeduct);

    const est = med * area * adj;
    const low = q1*0.95 * area * adj;
    const high= q3*1.05 * area * adj;

    log(`Ajuste final: ${adj.toFixed(3)} (incl. fotos: -${(imgDeduct*100).toFixed(0)}%)`);
    return {
      estimate: Math.round(est),
      low: Math.round(low),
      high: Math.round(high),
      compsCount: comps.length,
      report: [
        ...(imageAdj.reasons?.length ? imageAdj.reasons : ['• IA de fotos indisponível ou sem indícios.']),
        `• Ajuste por inflação de anúncios: -${(INFLATION_DISCOUNT*100)}%`,
        ...(Number(input.yearBuilt)>=2010 ? ['• Imóvel mais recente (≥2010): +5%'] : []),
        ...(f.size ? [`• Características: ${[...f].join(', ')}.`] : [])
      ]
    };
  }

  // === IA de fotos com conversão para ImageData (fix mobile) ===
  async function analyzePhotosOrFallback(files){
    if (!files.length) return { deduct:0, reasons:['• Sem fotos: sem ajustes por condição.'] };
    try {
      setStatus('A carregar IA de fotos (se demorar, seguimos sem IA)…');
      const mod = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.15.0');
      const clf = await mod.pipeline('zero-shot-image-classification', 'Xenova/clip-vit-base-patch32');
      setStatus('A analisar fotos…');

      const LABELS = [
        { text: "mold, mildew, damp, humidity stain", base:0.07, reason:"Humidade/bolor" },
        { text: "water leak, water stain, leakage",   base:0.06, reason:"Infiltrações/manchas de água" },
        { text: "peeling paint, flaking paint",       base:0.04, reason:"Tinta a descascar" },
        { text: "crack, cracks in wall or ceiling",   base:0.05, reason:"Fissuras visíveis" },
        { text: "rust, corrosion",                    base:0.03, reason:"Ferrugem/corrosão" }
      ];
      const subset = files.slice(0,6);
      let total=0; const reasons=[];

      const fileToImage = (file)=>new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = ()=>{ const img=new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=fr.result; };
        fr.onerror=reject; fr.readAsDataURL(file);
      });

      for (let i=0;i<subset.length;i++){
        setStatus(`A analisar fotos (${i+1}/${subset.length})…`);
        const img = await fileToImage(subset[i]);

        // >>> FIX: converter para ImageData antes de passar ao modelo <<<
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth || img.width;
        canvas.height = img.naturalHeight || img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        const res = await clf(imageData, LABELS.map(l=>l.text));
        res.forEach((r,idx)=>{
          const w = Math.max(0.5, Math.min(1, r.score));
          const d = LABELS[idx].base * w;
          if (r.score >= 0.35) { total += d; reasons.push(`• ${LABELS[idx].reason}: -${(d*100|0)}% (conf.: ${(r.score*100|0)}%)`); }
        });
      }
      total = Math.min(0.25, total);
      setStatus('');
      log('IA de fotos OK. Dedução: '+(total*100|0)+'%');
      return { deduct: total, reasons: reasons.length?reasons:['• Não foram detectados sinais claros de humidade/obras.'] };
    } catch (e) {
      log('Falha IA de fotos: ' + (e && (e.message||e)));
      setStatus('IA de fotos indisponível — cálculo segue sem análise de fotos.');
      return { deduct:0, reasons:['• IA de fotos indisponível no dispositivo.'] };
    }
  }

  // Submissão
  document.getElementById('valuationForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const result = document.getElementById('valuationResult');
    const repBox = document.getElementById('aiReport');
    const repTxt  = document.getElementById('aiReportTxt');
    setStatus('A processar…'); result.style.display='none'; repBox.style.display='none'; $('#debug').textContent='–';

    try{
      const files = Array.from(document.getElementById('photos')?.files || []);
      const imageAdj = await analyzePhotosOrFallback(files);

      const payload = {
        address: document.getElementById('address').value,
        typology: document.getElementById('typology').value,
        areaUseful: document.getElementById('areaUseful').value,
        yearBuilt: document.getElementById('yearBuilt').value,
        features: getCheckedFeatures()
      };
      const data = await estimateLocal(payload, imageAdj);

      document.getElementById('estMain').textContent  = fmtEUR(data.estimate);
      document.getElementById('estRange').textContent = `${fmtEUR(data.low)} – ${fmtEUR(data.high)}`;
      document.getElementById('estComps').textContent = data.compsCount ?? '—';

      repTxt.innerHTML = (data.report || []).join('<br>');
      repBox.style.display = 'block';

      setStatus('');
      result.style.display = 'block';
    }catch(err){
      console.error(err);
      log('Erro: ' + (err && (err.message||err)));
      setStatus('Erro: não foi possível calcular. Verifica a área (m²) e tenta outra vez.');
    }
  });

  log('Pronto. Se clicares em "Obter avaliação" vês aqui o log dos passos.');
});
</script>
</body>
</html>
