(function(){const L=[{text:"mold, mildew, damp, humidity stain",base:.07,reason:"Humidade/bolor"},{text:"water leak, water stain, leakage",base:.06,reason:"Infiltrações/manchas de água"},{text:"peeling paint, flaking paint",base:.04,reason:"Tinta a descascar"},{text:"crack, cracks in wall or ceiling",base:.05,reason:"Fissuras visíveis"},{text:"rust, corrosion",base:.03,reason:"Ferrugem/corrosão"}];const MAX=.25;let pipe=null;function fileToImage(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=r.result};r.onerror=rej;r.readAsDataURL(f)});}async function getPipe(){if(pipe)return pipe;const {pipeline}=await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.15.0');pipe=await pipeline('zero-shot-image-classification','Xenova/clip-vit-base-patch32');return pipe;}window.aiAnalyzePhotos=async function(files,set){try{const list=Array.from(files||[]).slice(0,6);if(!list.length)return{deduct:0,reasons:["• Sem fotos: sem ajustes por condição."]};set&&set("A carregar modelo de IA...");const clf=await getPipe();let total=0, reasons=[];for(let i=0;i<list.length;i++){set&&set(`A analisar fotos (${i+1}/${list.length})...`);const img=await fileToImage(list[i]);let res;try{res=await clf(img,L.map(x=>x.text));}catch(e){const c=document.createElement('canvas');c.width=img.naturalWidth||img.width;c.height=img.naturalHeight||img.height;const ctx=c.getContext('2d');ctx.drawImage(img,0,0);res=await clf(ctx.getImageData(0,0,c.width,c.height),L.map(x=>x.text));}res.forEach((r,idx)=>{const s=Number(r.score)||0;if(s>=.35){const d=L[idx].base*Math.max(.5,Math.min(1,s));total+=d;reasons.push(`• ${L[idx].reason}: -${(d*100|0)}% (conf.: ${(s*100|0)}%)`);}});}total=Math.min(MAX,total);if(!reasons.length)reasons.push("• Não foram detetados sinais claros de humidade/obras.");set&&set("");return{deduct:total,reasons};}catch(err){console.error("Falha IA de fotos:",err);set&&set("IA de fotos indisponível — cálculo sem análise de fotos.");return{deduct:0,reasons:["• IA de fotos indisponível no dispositivo."]};}}})();